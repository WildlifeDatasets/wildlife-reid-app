FROM python:3.10.13-slim

# install system dependencies
#RUN sudo add-apt-repository ppa:ubuntugis/ppa
RUN apt-get update --yes &&  \
    apt-get install --yes \
    wget \
    unzip \
    ffmpeg \
    curl \
    gdal-bin && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# This approximately follows this guide: https://hynek.me/articles/docker-uv/
# Which creates a standalone environment with the dependencies.
# - Silence uv complaining about not being able to use hard links,
# - tell uv to byte-compile packages for faster application startups,
# - prevent uv from accidentally downloading isolated Python builds,
# - pick a Python (use `/usr/bin/python3.12` on uv 0.5.0 and later),
# - and finally declare `/app` as the target for `uv sync`.
ENV UV_LINK_MODE=copy \
    UV_COMPILE_BYTECODE=1 \
    UV_PYTHON_DOWNLOADS=never \
    UV_PROJECT_ENVIRONMENT=/code/.venv

COPY --from=ghcr.io/astral-sh/uv:0.5.2 /uv /uvx /bin/

RUN uv venv /code/.venv
ENV PATH="/code/.venv/bin:$PATH"

COPY ./src/api/requirements.txt /api/requirements.txt

# install python dependencies
ENV APP_DIR='/api'
WORKDIR $APP_DIR
RUN uv pip install --no-cache-dir --upgrade pip build && \
    uv pip install --no-cache-dir --compile --prerelease=allow -r requirements.txt && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/* /tmp/* /var/tmp/*
RUN uv pip install https://github.com/BohemianVRA/FGVC/releases/download/v1.5.4-dev/fgvc-1.5.4.dev0-py3-none-any.whl

RUN uv pip install pytz --upgrade
RUN uv pip install tzdata --upgrade

RUN uv pip install openpyxl pyproj django-cruds-adminlte

COPY ./src/api/start_dev.sh /api/start_dev.sh

# expose ports and run application
WORKDIR $APP_DIR
ENV PYTHONUNBUFFERED=1
EXPOSE 8080
CMD bash ./start_dev.sh
