{% extends 'base.html' %}
{% load widget_tweaks %}

{% block head %}
    <!-- Bootstrap Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
            integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
            crossorigin="anonymous"></script>
    <!-- Bootstrap Datepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

{% endblock %}
{% block body %}
    <style>
        .not-visible {
            display: none;
        }
    </style>
    {#<div class="container">#}
    {% if user.is_authenticated %}
        <div class="pagetitle">
            <h1>{{ headline }}</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'caidapp:uploads' %}">Uploads</a></li>
                </ol>
            </nav>
        </div><!-- End Page Title -->
        <div class="section">
            <p class="text-danger">{{ error_text }}</p>
            <p class="text"> {{ text_note }}</p>

            <form method="post" enctype="multipart/form-data" id="upload_form">
                {% csrf_token %}
                {#                {{ form.as_p }}#}

                {% for field in form %}
                    <div class="form-group mt-2">
                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        <span class="text-danger">{{ field.errors }}</span>
                        {{ field|add_class:"form-control" }}
                        <span class="text-muted">{{ field.help_text}}</span>
                    </div>
                {% endfor %}

                <p>
                <div class="progress not-visible" id="progress"></div>
                </p>
                <button class="btn btn-primary" id="btnUpload" type="submit">
                    {#                    <span class="spinner"><i class="fa fa-refresh fa-spin"></i></span>#}
                    <i class="fa fa-upload"></i>
                    {{ button }}
                </button>
                {#                <a class="btn btn-secondary" href="{% url 'caidapp:uploads' %}">Cancel</a>#}

            </form>
        </div>
        </form>
        </div>
        </div>
    {% endif %}
    {#</div>#}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let isUploading = false;

        const uploadForm = document.getElementById('upload_form');
        const input_file = document.getElementById('id_archivefile');
        const progress_bar = document.getElementById('progress');

         input_file.addEventListener('change', function() {
            if (input_file.files.length > 0) {
                isUploading = true;
            } else {
                isUploading = false;
            }
        });
        $("#upload_form").submit(function (e) {
            e.preventDefault();
            $form = $(this)
            var formData = new FormData(this);
            const media_data = input_file.files[0];
            if (media_data != null) {
                progress_bar.classList.remove("not-visible");
                isUploading = true;  // Set uploading flag to true
            }

            $.ajax({
                type: 'POST',
                url: window.location.href,
                data: formData,
                dataType: 'json',
                beforeSend: function () {},
                xhr: function () {
                    const xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener('progress', e => {
                        if (e.lengthComputable) {
                            const percentProgress = (e.loaded / e.total) * 100;
                            const percentProgressInt = Math.round(percentProgress);
                            progress_bar.innerHTML = `<div class="progress-bar progress-bar-striped bg-success"
                                role="progressbar" style="width: ${percentProgress}%" aria-valuenow="${percentProgress}" aria-valuemin="0"
                                aria-valuemax="100">${percentProgressInt}%</div>`
                        }
                    });
                    return xhr
                },
                success: function (response) {
                    uploadForm.reset()
                    progress_bar.classList.add('not-visible')
                    isUploading = false;  // Reset uploading flag to false
                },
                error: function (err) {
                    console.log(err);
                    isUploading = false;  // Reset uploading flag to false on error
                },
                cache: false,
                contentType: false,
                processData: false,
            });
        });

        // Warn user if they try to leave the page during an upload
        window.addEventListener('beforeunload', function (e) {
            if (isUploading) {
                var confirmationMessage = 'An upload is in progress. Are you sure you want to leave?';
                (e || window.event).returnValue = confirmationMessage;
                return confirmationMessage;
            }
        });

        const inputFile = document.getElementById('id_archivefile');
        const dateField = document.getElementById('id_location_check_at');
        const locationField = document.getElementById('id_location_at_upload');
        const datepickerInput = $('.datepicker');

        inputFile.addEventListener('change', function() {
            const file = inputFile.files[0];
            if (file) {
                const filename = file.name;
                const match = filename.match(/^(\d{4}-\d{2}-\d{2})_(.+)\.zip$/);
                if (match) {
                    const date = match[1];
                    const locality = match[2];

                    // Set the date field value
                    dateField.value = date;
                    datepickerInput.datepicker('update', date);

                    // Set the location field value (assuming the location field is a text input or similar)
                    locationField.value = locality;

                    console.log(`Parsed date: ${date}, locality: ${locality}`);
                } else {
                    console.error('Filename format is incorrect');
                }
            }
        });

        // Initialize datepicker
        datepickerInput.datepicker({
            format: 'yyyy-mm-dd',
            orientation: 'bottom',
            autoclose: true
        }).on('changeDate', function(e) {
            $(this).datepicker('hide');
        });
    });
    </script>


    <script type="module">
        import Autocomplete from "https://cdn.jsdelivr.net/gh/lekoala/bootstrap5-autocomplete@master/autocomplete.js";

        const opts = {
            onSelectItem: console.log,
        };
        var src = [
            {%  for location in locations %}
                {title: "{{ location.name }}", id: "{{ location.id }}", data: {key: {{ location.id }}}},
            {% endfor %}
        ];
        Autocomplete.init("input.autocomplete", {
            items: src,
            valueField: "id",
            labelField: "title",
            highlightTyped: true,
            onSelectItem: console.log,
        });
        new Autocomplete(document.getElementById("id_location_at_upload"), opts);


    </script>
    <style>
        /* highlightTyped use mark */
        .autocomplete-menu mark {
            text-decoration: underline;
            background: none;
            color: currentColor;
            padding: 0;
        }

        /* Optional nicer scrollbars */
        .autocomplete-menu {
            --scroller-color: 0, 0%;
            --scroller-color-lightness: 80%;
            --scroller-bg-lightness: 90%;
            --scroller-hover-factor: 0.8;
            --scroller-thumb: hsl(var(--scroller-color), var(--scroller-color-lightness));
            /* Replicate hover for webkit */
            --scroller-thumb-hover: hsl(var(--scroller-color), calc(var(--scroller-color-lightness) * var(--scroller-hover-factor)));
            --scroller-background: hsl(var(--scroller-color), calc(var(--scroller-bg-lightness)));
            scrollbar-color: var(--scroller-thumb) var(--scroller-background);
            scrollbar-width: thin;
        }

        .autocomplete-menu::-webkit-scrollbar {
            width: 8px;
        }

        .autocomplete-menu::-webkit-scrollbar-track {
            background: var(--scroller-background);
        }

        .autocomplete-menu::-webkit-scrollbar-thumb {
            background: var(--scroller-thumb);
        }

        .autocomplete-menu::-webkit-scrollbar-thumb:hover {
            background: var(--scroller-thumb-hover);
        }
    </style>


{% endblock %}