{% extends 'base.html' %}
{% load custom_filters %}
{% load crispy_forms_tags %}
{# add style #}
{% block head %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        /* Increase the size of the carousel control icons */
        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background for better visibility */
            background-size: 50%; /* Adjust the size of the arrow icon */
            width: 3rem;
            height: 3rem;
            border-radius: 50%; /* Makes the control icons circular */
        }

        /* Optional: Add a border around the icons */
        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            border: 2px solid white;
        }

        /* Change the hover effect for the arrows */
        .carousel-control-prev:hover .carousel-control-prev-icon,
        .carousel-control-next:hover .carousel-control-next-icon {
            background-color: rgba(0, 0, 0, 0.8); /* Darker background on hover */
        }

        /* Adjust the position of the arrows */
        .carousel-control-prev,
        .carousel-control-next {
            top: 50%; /* Center the controls vertically */
            transform: translateY(-50%);
        }
    </style>
{% endblock %}
{# add body #}

{% block body %}
    {#<div class="container">#}
    {% if user.is_authenticated %}
        <div class="pagetitle">
            <div style="display: flex; justify-content: space-between">

                <div>
                    <h1>{{ headline }}</h1>
                    <nav>
                        <ol class="breadcrumb">
                            {% if mediafile.parent.contains_single_taxon %}
                                <li class="breadcrumb-item"><a href="{% url 'caidapp:uploads_identities' %}">Identities
                                    Uploads </a></li>
                            {% else %}
                                <li class="breadcrumb-item"><a href="{% url 'caidapp:uploads' %}"> Taxon Uploads</a>
                                </li>
                            {% endif %}
                            <li class="breadcrumb-item"><a
                                    href="{% url 'caidapp:uploadedarchive_mediafiles' mediafile.parent.id %}"> Uploaded
                                Archive: {{ mediafile.parent }}</a></li>
                        </ol>
                    </nav>
                </div>
                <div>

                    <div class="dropdown mt-3">
                        {#                                <div class="dropdown d-inline-block">#}
                        <a class="btn btn-secondary dropdown-toggle" href="#" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots"></i>
                        </a>

                        <ul class="dropdown-menu">
                            {% if request.user.is_staff %}

                                <li>
                                    <a class="dropdown-item"
                                       href="{% url 'admin:caidapp_mediafile_change' mediafile.id %}">
                                        <i class="bi bi-lock"></i>
                                        Edit in admin
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item"
                                       href="{{ mediafile.detection_url }}">
                                        Get detection image
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item"
                                       href="{{ mediafile.thumbnail_url }}">
                                        Get thumbnail image
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item"
                                       href="{{ mediafile.static_thumbnail_url }}">
                                        Get static thumbnail image
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item"
                                       href="{{ mediafile.preview_url }}">
                                        Get preview image
                                    </a>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                            {% endif %}
                            <li>

                                {#                                            download mediafile#}
                                <a class="dropdown-item"
                                   href="{{ mediafile.mediafile.url }}" download>
                                    <i class="bi bi-download"></i> Download media file
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item text-danger"
                                   href="{% url 'caidapp:delete_mediafile' mediafile.id %}"
                                   onclick="return confirm('Delete file {{ mediafile }}?')">
                                    <i class="bi bi-trash"></i> Delete
                                </a>

                            </li>
                        </ul>
                    </div>
                </div>
            </div>


            {% if mediafile.sequence.mediafile_set.all|length > 1 and mediafile.media_type == 'image' %}
                <div id="mediafileCarousel" class="carousel slide">
                    <div class="carousel-inner">
                        {% for chunk in mediafile.sequence.mediafile_set.all|chunk:5 %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                <div class="d-flex justify-content-center">
                                    {% for sequence_mediafile in chunk %}
                                        <div class="m-2">
                                            <a href="{% url 'caidapp:media_file_update' sequence_mediafile.id %}">
                                                <img src="{{ sequence_mediafile.static_thumbnail.url }}"
                                                     class="img-fluid"
                                                     alt="Media Thumbnail" style="max-width: 100px;"
                                                     fetchpriority="low"
                                                        {% if not forloop.parentloop.first %}
                                                     loading="lazy"
                                                        {% endif %}
                                                >
                                            </a>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    {% if mediafile.sequence.mediafile_set.all|length > 5 %}
                        <!-- Carousel Controls -->
                        <button class="carousel-control-prev" type="button" data-bs-target="#mediafileCarousel"
                                data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#mediafileCarousel"
                                data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    {% endif %}
                </div>
            {% endif %}

        </div><!-- End Page Title -->
        {#        {% if  mediafile.sequence.mediafile_set.all  > 1 %}#}
        {#               <div class="d-flex flex-row flex-wrap m-1" style="width:auto;">#}
        {##}
        {#                    {% for sequence_mediafile in mediafile.sequence.mediafile_set.all %}#}
        {#                        <a href="{% url 'caidapp:media_file_update' sequence_mediafile.id %}" class="m-1">#}
        {#                            <img src="{{ sequence_mediafile.thumbnail.url }}" class="img-fluid" alt="Camera trap image" style="max-width: 100px;">#}
        {#                        </a>#}
        {#                    {% endfor %}#}
        {##}
        {#                </div>#}

        {#        {% endif %}#}
        <div class="section">
            <div class="row">
                {#                <div class="col-lg-4 col-xl-2">#}
                <div class="col-auto">
                    <div class="card">
                        {#                <div class="card-header">#}
                        {#                </div>#}
                        <div class="card-body">
                            <div style="display: flex; justify-content: space-between">
                                <form method="post" enctype="multipart/form-data" class="mt-3">
                                    {% csrf_token %}
                                    {#                                    {{ form }}#}
                                    {#                                                    {{ form.as_p }}#}
                                    <div class="form-group">

                                        <h5>Observations</h5>

                                        <div>


                                            <div id="observation-forms">
                                                {% for inline in inlines %}
                                                    {{ inline.management_form }}

                                                    {% for obs_form in inline %}
                                                        <div class="mb-2 border rounded p-2 observation-form"
                                                             data-obs-id="{{ obs_form.instance.pk|default:'new' }}">
                                                            {#                                                            Observation {{ forloop.counter }},#}
                                                            {#                                                            pk: {{ obs_form.instance.pk }}: <br>#}

                                                            {#                                                            {{ obs_form.as_p }}#}

                                                            {{ obs_form.id }}
                                                            {% if mediafile.is_for_suggestion  and forloop.counter == 1 %}
                                                                {#                                                            {% if mediafile.is_for_suggestion  %}#}
                                                                <div>

                                                                    <i class="bi bi-question-circle me-2"></i>
                                                                    {{ obs_form.instance.predicted_taxon }}
                                                                    ({{ obs_form.instance.predicted_taxon_confidence|mul:100|floor|floatformat:0 }}%)
                                                                    <a href="#"
                                                                       name="confirmTaxonSubmit"
                                                                       class="btn btn-sm btn-outline-secondary"
                                                                       id="confirmTaxonSubmit"
                                                                            {#                                                        type="submit"#}
                                                                       onclick="setCategoryAndSubmitInObservation('{{ obs_form.instance.predicted_taxon }}', {{ forloop.counter|add:'-1' }});"
                                                                    >
                                                                        Select
                                                                    </a>


                                                                </div>
                                                            {% endif %}
                                                            {% include 'caidapp/include_observation_fields_to_media_file_update.html' %}


                                                            {% if obs_form.instance.pk %}
                                                                <button type="button"
                                                                        class="btn btn-outline-danger btn-sm delete-observation-btn">
                                                                    <i class="bi bi-trash"></i> Delete
                                                                </button>

                                                                <div class="dropdown d-inline-block mt-3">
                                                                    {#                                <div class="dropdown d-inline-block">#}
                                                                    <a class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                                                       href="#" role="button"
                                                                       data-bs-toggle="dropdown" aria-expanded="false">
                                                                        <i class="bi bi-three-dots"></i>
                                                                    </a>

                                                                    <ul class="dropdown-menu">
                                                                        {% if request.user.is_staff %}

                                                                            <li>
                                                                                <a class="dropdown-item"
                                                                                   href="{% url 'admin:caidapp_animalobservation_change' obs_form.instance.pk %}">
                                                                                    <i class="bi bi-lock"></i>
                                                                                    Edit in admin
                                                                                </a>
                                                                            </li>
                                                                        {% endif %}
                                                                    </ul>
                                                                </div>
                                                            {% endif %}
                                                            <span

                                                                    title="File name: {{ mediafile }}
Observation ID: {{ obs_form.instance.id }}
{% if obs_form.instance.taxon %}Observation Taxon: {{ obs_form.instance.taxon }}{% endif %}
{% if obs_form.instance.identity %}Observation Identity: {{ obs_form.instance.identity }}{% endif %}
{% if obs_form.instance.uploaded_by %}Observation Uploaded by: {{ obs_form.instance.uploaded_by }}{% endif %}
{% if obs_form.instance.updated_by %}Observation Updated by: {{ obs_form.instance.updated_by }}{% endif %}
{% if obs_form.instance.created_at %}Observation Created at: {{ obs_form.instance.created_at|date:'Y-m-d H:i' }}{% endif %}
{% if obs_form.instance.updated_at %}Observation Updated at: {{ obs_form.instance.updated_at|date:'Y-m-d H:i' }}{% endif %}
"
                                                            >
                                                                                                        <i class="bi bi-info-circle"></i>
                                                                                                        </span>
                                                            {{ obs_form.DELETE.as_hidden }}
                                                        </div>
                                                    {% endfor %}

                                                {% endfor %}
                                            </div> <!-- end of observation-forms -->
                                            <!-- Hidden empty form for cloning -->
                                            <div id="empty-form" class="d-none">
                                                {#    {{ inlines.0.empty_form|crispy }}#}
                                                {% with inlines.0.empty_form as obs_form %}
                                                    {{ obs_form.id }}
                                                    {% include 'caidapp/include_observation_fields_to_media_file_update.html' %}
                                                {% endwith %}
                                                {#    {{ inlines.0.empty_form.as_p }}#}
                                            </div>

                                            <button type="button" id="add-observation-btn"
                                                    class="btn btn-outline-primary mt-2">
                                                <i class="bi bi-plus-circle"></i> Add Observation
                                            </button>
                                            {#                                            <button type="button" id="add-observation-btn"#}
                                            {#                                                    class="btn btn-outline-primary">#}
                                            {#                                                Add Observation#}
                                            {#                                            </button>#}
                                        </div>
                                        {# end of observations #}
                                        <h5 class="mt-2">Media File</h5>

                                        {% for field in form %}
                                            <div>
                                                <label for="{{ field.id_for_label }}"
                                                       class="mt-1">{{ field.label }}</label><br>
                                                <!-- Label on its own line -->
                                                {{ field }}  <!-- Field on the next line -->
                                                {% if field.id_for_label == "id_identity" %}
                                                    <button type="button" class="btn btn-outline-primary btn-sm"
                                                            onclick="window.location.href='{% url 'caidapp:individual_identity_create' mediafile.id %}?next={{ request.path }}'">
                                                        <i class="bi-plus"></i></button>
                                                {% endif %}
                                                {% if field.help_text %}
                                                    <small class="form-text text-muted">{{ field.help_text }}</small>
                                                {% endif %}
                                                {% for error in field.errors %}
                                                    <div class="alert alert-danger"
                                                         id="error_{{ field.id_for_label }}">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endfor %}
                                        {# end of mediafile fields #}


                                    </div>


                                    <button class="btn btn-primary mt-1" id="btnUpload" type="submit">
                                        {{ button|default:"Save" }}
                                    </button>
                                    {% if save_and_continue_button %}
                                        <button class="btn btn-primary mt-1" id="btnSaveAndContinue" type="submit">
                                            {{ save }}
                                        </button>

                                    {% endif %}
                                    {% if  skip_url %}
                                        <a href="{{ skip_url }}" class="btn btn-secondary mt-1 ">Skip</a>
                                    {% endif %}
                                    {% if  cancel_url %}
                                        <a href="{{ cancel_url }}" class="btn btn-secondary mt-1 ">Cancel</a>
                                    {% endif %}


                                </form>
                            </div>

                            <div class="position-absolute bottom-0 end-0 p-3">
                                    <span
                                            {#                                            data-bs-toggle="tooltip"#}
                                            {#                                            data-toggle="tooltip"#}
                                            title="File name: {{ mediafile }}
ID: {{ mediafile.id }}
mediafile.taxon: {{ mediafile.taxon }}
{% if mediafile.taxon %}Media file Taxon: {{ mediafile.taxon }}{% endif %}
{% if mediafile.identity %}Media file Identity: {{ mediafile.identity }}{% endif %}
{% if mediafile.uploaded_by %}Media file Uploaded by: {{ mediafile.uploaded_by }}{% endif %}
{% if mediafile.updated_by %}Media file Updated by: {{ mediafile.updated_by }}{% endif %}
{% if mediafile.created_at %}Media file Created at: {{ mediafile.created_at|date:'Y-m-d H:i' }}{% endif %}
{% if mediafile.updated_at %}Media file Updated at: {{ mediafile.updated_at|date:'Y-m-d H:i' }}{% endif %}
">
                                    <i class="bi bi-info-circle"></i>
                                    </span>

                            </div>

                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="d-flex flex-row flex-wrap align-items-start col">
                        {% if mediafile.media_type == 'video' %}
                            <video controls autoplay muted width="640" class="m-1" preload="auto">
                                <source src="{% url 'caidapp:stream_video' mediafile.id %}" type="video/x-m4v">
                                Your browser does not support the video tag.
                            </video>

                            <!-- Thumbnail with modal trigger -->
                            {#                            <img src="{{ mediafile.thumbnail.url }}" class="img-fluid m-1" alt="Camera trap image"#}
                            {#                                 style="max-width: 320px;" data-bs-toggle="modal"#}
                            {#                                 data-bs-target="#imageModal{{ mediafile.id }}"#}
                            {#                                 fetchpriority="high"#}
                            {#                            >#}
                            {#                            <canvas id="annotCanvas"#}
                            {#                                style="max-width: 600px;"#}
                            {##}
                            {#                                class="img-fluid"#}
                            {#                                    style="border:1px solid #ccc; margin-top:10px;"></canvas>#}
                            {#                                <img id="annotatable-image" src="{{ mediafile.static_thumbnail.url }}" hidden>#}

                        {% else %}
                            <!-- Image with modal trigger -->

                            <!-- Canvas -->
                            <canvas id="annotCanvas"
                                    {#                                style="max-width: 600px;"#}

                                    {#                                class="img-fluid"#}
                                    style="border:1px solid #ccc; margin-top:10px;"></canvas>
                            <img id="annotatable-image" src="{{ mediafile.preview.url }}" hidden>


                            {#                            <img id="annotatable-image" src="{{ mediafile.preview.url }}" class="img-fluid"#}
                            {#                                 alt="Camera trap image">#}
                            {#                        <div class="position-relative d-inline-block m-1"#}
                            {#                             style="max-width: 100%; cursor: pointer;"#}
                            {#                             data-bs-toggle="modal" data-bs-target="#imageModal{{ mediafile.id }}">#}
                            {##}
                            {#                            <img src="{{ mediafile.preview.url }}" class="img-fluid" alt="Camera trap image">#}
                            {##}
                            {#                            {% for obs in mediafile.observations.all %}#}
                            {#                                {% if obs.bbox_x_center %}#}
                            {#                                    <div class="bbox-overlay"#}
                            {#                                         style="#}
                            {#                                                 position: absolute;#}
                            {#                                                 border: 2px solid red;#}
                            {#                                                 box-sizing: border-box;#}
                            {#                                                 left: calc(({{ obs.bbox_x_center }} - {{ obs.bbox_width }}/2) * 100%);#}
                            {#                                                 top: calc(({{ obs.bbox_y_center }} - {{ obs.bbox_height }}/2) * 100%);#}
                            {#                                                 width: calc({{ obs.bbox_width }} * 100%);#}
                            {#                                                 height: calc({{ obs.bbox_height }} * 100%);#}
                            {#                                                 ">#}
                            {#                                    </div>#}
                            {#                                {% endif %}#}
                            {#                            {% endfor %}#}
                            {#                        </div>#}






                            {#                        <img src="{{ mediafile.preview.url }}" class="img-fluid m-1" alt="Camera trap image"#}
                            {#                             data-bs-toggle="modal" data-bs-target="#imageModal{{ mediafile.id }}"#}
                            {#                             fetchpriority="high"#}
                            {#                        >#}

                        {% endif %}
                    </div>
                </div>
                <!-- Bootstrap Modal for showing the larger image -->
                <div class="modal fade" id="imageModal{{ mediafile.id }}" tabindex="-1"
                     aria-labelledby="imageModalLabel{{ mediafile.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="imageModalLabel{{ mediafile.id }}">Full Size Image</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <img src="{{ mediafile.preview.url }}" class="img-fluid" alt="Full Size Image">
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    {% endif %}
    {#</div>#}
{% endblock %}
{% block script %}
    <script>
        function setCategoryAndSubmitInObservation(predictedTaxon, observationIndex) {
            {#const categoryDropdown = document.getElementById('id_observations-0-taxon');#}
            const categoryDropdown = document.getElementById('id_observations-' + observationIndex + '-taxon');
            const options = categoryDropdown.options;

            // Loop through options to find and select the predicted taxon
            for (let i = 0; i < options.length; i++) {
                if (options[i].text === predictedTaxon) {
                    categoryDropdown.selectedIndex = i;
                    break;
                }
            }
        }

        function setCategoryAndSubmit(predictedTaxon) {
            const categoryDropdown = document.getElementById('id_taxon');
            {#const categoryDropdown = document.getElementById('id_observations-0-taxon');#}
            const options = categoryDropdown.options;

            // Loop through options to find and select the predicted taxon
            for (let i = 0; i < options.length; i++) {
                if (options[i].text === predictedTaxon) {
                    categoryDropdown.selectedIndex = i;
                    break;
                }
            }
        }

    </script>


    <script>


        function getColorForObsId(obsId) {
            const palette = [
                '#ff4d4d', '#4d94ff', '#4dff88', '#ffb84d',
                '#ff4dff', '#b84dff', '#4dffff', '#ffd24d'
            ];
            // hash id → index v paletě
            const index = Math.abs(
                obsId.split('').reduce((acc, c) => acc + c.charCodeAt(0), 0)
            ) % palette.length;
            return palette[index];
        }

        document.addEventListener("DOMContentLoaded", function () {
            const canvas = new fabric.Canvas('annotCanvas');
            const imgElement = document.getElementById("annotatable-image");

            fabric.Image.fromURL(imgElement.src, function (img) {
                const scale = 600 / img.width;
                img.scale(scale);
                canvas.setWidth(img.width * scale);
                canvas.setHeight(img.height * scale);
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));

                // helper – přidání bboxu s barvou
                function addObservationBox(obsId, xCenter, yCenter, width, height, color) {
                    const absX = (xCenter - width / 2) * canvas.width;
                    const absY = (yCenter - height / 2) * canvas.height;
                    const absW = width * canvas.width;
                    const absH = height * canvas.height;

                    console.log(`Adding observation ${obsId} at (${absX}, ${absY}, ${absW}, ${absH}) with color ${color}`);


                    const rect = new fabric.Rect({
                        left: absX,
                        top: absY,
                        width: absW,
                        height: absH,
                        fill: 'rgba(0,0,0,0)',
                        stroke: color,
                        strokeWidth: 3,
                        strokeUniform: true,
                        lockRotation: true,
                        objectCaching: false
                    });


                    rect.obsId = obsId;
                    canvas.add(rect);
                    console.log(`Created rect:`, rect);
                    console.log(`left: ${rect.left}, top: ${rect.top}, width: ${rect.width}, height: ${rect.height}`);


                    canvas.bringToFront(rect);
                    canvas.renderAll();
                    return rect;
                }

                function removeObservationBox(obsId) {
                    const target = canvas.getObjects().find((o) => o.obsId === obsId);
                    if (target) {
                        canvas.remove(target);
                        canvas.renderAll();
                    }
                }

                // připravíme barvy
                {#const palette = ["#ff3b3b", "#2ecc71", "#3498db", "#f39c12", "#9b59b6", "#1abc9c", "#e67e22", "#e84393"];#}
                {# let colorIndex = 0;#}

                // projdeme všechny formuláře a přidáme bboxy se stejnou barvou
                document.querySelectorAll(".observation-form").forEach(formDiv => {
                    const obsId = formDiv.dataset.obsId;
                    console.log(`Loading existing observation ${obsId}`);
                    const x = parseFloat(formDiv.querySelector('[name$="bbox_x_center"]').value);
                    const y = parseFloat(formDiv.querySelector('[name$="bbox_y_center"]').value);
                    const w = parseFloat(formDiv.querySelector('[name$="bbox_width"]').value);
                    const h = parseFloat(formDiv.querySelector('[name$="bbox_height"]').value);
                    {#const color = palette[colorIndex++ % palette.length];#}
                    const color = getColorForObsId(obsId);

                    formDiv.style.borderColor = color;

                    if (!isNaN(x) && !isNaN(y) && !isNaN(w) && !isNaN(h)) {
                        addObservationBox(obsId, x, y, w, h, color);
                        formDiv.querySelector(".add-bbox-btn").classList.add("d-none");
                        formDiv.querySelector(".remove-bbox-btn").classList.remove("d-none");
                    }

                });


                // Přidání bboxu k pozorování
                document.addEventListener("click", (e) => {
                    if (e.target.classList.contains("add-bbox-btn")) {
                        const formDiv = e.target.closest(".observation-form");
                        const obsId = formDiv.dataset.obsId;
                        const color = getColorForObsId(obsId);

                        const rect = addObservationBox(obsId, 0.5, 0.5, 0.2, 0.2, color);
                        formDiv.querySelector('[name$="bbox_x_center"]').value = 0.5;
                        formDiv.querySelector('[name$="bbox_y_center"]').value = 0.5;
                        formDiv.querySelector('[name$="bbox_width"]').value = 0.2;
                        formDiv.querySelector('[name$="bbox_height"]').value = 0.2;

                        e.target.classList.add("d-none");
                        formDiv.querySelector(".remove-bbox-btn").classList.remove("d-none");
                    }

                    if (e.target.classList.contains("remove-bbox-btn")) {
                        const formDiv = e.target.closest(".observation-form");
                        const obsId = formDiv.dataset.obsId;
                        removeObservationBox(obsId);

                        // Vyčistit hodnoty
                        formDiv.querySelector('[name$="bbox_x_center"]').value = "";
                        formDiv.querySelector('[name$="bbox_y_center"]').value = "";
                        formDiv.querySelector('[name$="bbox_width"]').value = "";
                        formDiv.querySelector('[name$="bbox_height"]').value = "";

                        e.target.classList.add("d-none");
                        formDiv.querySelector(".add-bbox-btn").classList.remove("d-none");
                    }
                });


                // aktualizace při posunu/změně
                canvas.on('object:modified', function (e) {
                    const rect = e.target;
                    const formDiv = document.querySelector('.observation-form[data-obs-id="' + rect.obsId + '"]');
                    if (!formDiv) return;

                    console.log("{rect.left}, {rect.top}, {rect.width}, {rect.height}");
                    console.log("Canvas size: ", canvas.width, canvas.height);
                    console.log("Image size: ", img.width * scale, img.height * scale);
                    console.log("left: ", rect.left)
                    console.log("top: ", rect.top)
                    console.log("width: ", rect.width)
                    console.log("height: ", rect.height)

                    const scaledWidth = rect.getScaledWidth();
                    const scaledHeight = rect.getScaledHeight();

                    const xCenter = (rect.left + scaledWidth / 2) / canvas.width;
                    const yCenter = (rect.top + scaledHeight / 2) / canvas.height;
                    const bbox_width = scaledWidth / canvas.width;
                    const bbox_height = scaledHeight / canvas.height;


                    formDiv.querySelector('[name$="bbox_x_center"]').value = xCenter;
                    formDiv.querySelector('[name$="bbox_y_center"]').value = yCenter;
                    formDiv.querySelector('[name$="bbox_width"]').value = bbox_width;
                    formDiv.querySelector('[name$="bbox_height"]').value = bbox_height;
                });

                // zvýraznění – kliknutí na bbox nebo formulář
                canvas.on("mouse:down", function (e) {
                    if (!e.target) return;
                    const id = e.target.obsId;
                    document.querySelectorAll(".observation-form").forEach(f => f.classList.remove("bg-warning"));
                    const formDiv = document.querySelector(`.observation-form[data-obs-id="${id}"]`);
                    if (formDiv) formDiv.classList.add("bg-warning");
                });

                document.querySelectorAll(".observation-form").forEach(formDiv => {
                    formDiv.addEventListener("mouseenter", () => {
                        const id = formDiv.dataset.obsId;
                        const rect = canvas.getObjects().find(o => o.obsId === id);
                        if (rect) rect.set("strokeWidth", 6);
                        canvas.renderAll();
                    });
                    formDiv.addEventListener("mouseleave", () => {
                        const id = formDiv.dataset.obsId;
                        const rect = canvas.getObjects().find(o => o.obsId === id);
                        if (rect) rect.set("strokeWidth", 3);
                        canvas.renderAll();
                    });
                });


                {#// přidání nového bboxu#}
                {#document.getElementById("add-bbox-btn").addEventListener("click", function () {#}
                {#    const datenow = Date.now();#}
                {#    const newId = "new-" + datenow;#}
                {##}
                {#    // naklonovat empty_form#}
                {#    const emptyHtml = document.getElementById("empty-form").innerHTML.replace(/__prefix__/g, newId);#}
                {#    const wrapper = document.createElement("div");#}
                {#    wrapper.classList.add("observation-form");#}
                {#    wrapper.dataset.obsId = newId;#}
                {#    wrapper.innerHTML = emptyHtml;#}
                {#    document.getElementById("observation-forms").appendChild(wrapper);#}
                {#    const color = "#e84393"#}
                {##}
                {#    // přidat bbox na canvas#}
                {#    addObservation(newId, 0.5, 0.5, 0.2, 0.2, "", "", color);#}
                {#    const totalFormsInput = document.querySelector('[name="observations-TOTAL_FORMS"]');#}
                {#    totalFormsInput.value = parseInt(totalFormsInput.value) + 1;#}
                {# });#}


            });


        });


        document.addEventListener("DOMContentLoaded", function () {
            const addBtn = document.getElementById("add-observation-btn");
            const container = document.getElementById("observation-forms");
            const emptyFormDiv = document.getElementById("empty-form");
            const totalFormsInput = document.querySelector('[name$="TOTAL_FORMS"]');

            addBtn.addEventListener("click", function () {
                const formIndex = parseInt(totalFormsInput.value);
                const newFormHtml = emptyFormDiv.innerHTML.replace(/__prefix__/g, formIndex);
                const wrapper = document.createElement("div");
                wrapper.classList.add("mb-2", "border", "rounded", "p-2", "observation-form");
                wrapper.dataset.obsId = `new-${formIndex}`;
                wrapper.innerHTML = newFormHtml;
                container.appendChild(wrapper);

                totalFormsInput.value = formIndex + 1; // update management form count
            });
        });


        {#        document.addEventListener("click", function(e) {#}
        {#    if (e.target.closest(".delete-observation-btn")) {#}
        {#        const formDiv = e.target.closest(".observation-form");#}
        {#        if (confirm("Delete this observation?")) {#}
        {#            // Najdi DELETE checkbox a zaškrtni ho#}
        {#            const deleteInput = formDiv.querySelector('input[name$="-DELETE"]');#}
        {#            if (deleteInput) deleteInput.checked = true;#}
        {#            // Schovej formulář vizuálně (nepovinné)#}
        {#            formDiv.style.display = "none";#}
        {#        }#}
        {#    }#}
        {# });#}
        {##}

        document.addEventListener("click", function (e) {
            const btn = e.target.closest(".delete-observation-btn");
            if (!btn) return;

            const formDiv = btn.closest(".observation-form");
            if (confirm("Delete this observation?")) {
                const deleteInput = formDiv.querySelector('input[type="hidden"][name$="-DELETE"]');
                if (deleteInput) {
                    deleteInput.value = "on";  // musí být "on", ne true
                }
                // volitelné – skryj formulář z UI
                formDiv.style.display = "none";
            }
        });
    </script>

{% endblock %}