{% extends 'base.html' %}
{% load static %}
{% block head %}
    <style>
    .card-btn {
        background-repeat: no-repeat;
        background-position-x: right;
        background-position-y: center;
        background-size: cover;
    }

    </style>
    <!--refresh every 120 s-->
    {#<meta http-equiv="refresh" content="120">#}
{% endblock %}
{% block body %}
    {% if user.is_authenticated %}
        <div class="pagetitle">
            <h1>Identification dashboard</h1>
            <div>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'caidapp:home' %}"><i class="fa fa-home"></i> Home</a></li>
                    {#                    {% if uploadedarchive.contains_single_taxon %}#}
{#                    <li class="breadcrumb-item"><a href="{% url 'caidapp:uploads_identities' %}">Identities Uploads </a></li>#}
                    {#                    {% else %}#}
                    {#                        <li class="breadcrumb-item"><a href="{% url 'caidapp:uploads' %}">Uploads</a></li>#}
                    {#                    {%  endif %}#}
                    {#                <li class="breadcrumb-item"><a href="{% url 'caidapp:uploadedarchive_mediafiles' mediafile.parent.id %}"> Uploaded#}
                    {#                    Archive: {{ mediafile.parent }}</a></li>#}
{##}
                </ol>

                <div class="d-flex justify-content-between">

                    <div>

                        {% if user.caiduser.show_base_dataset %}
                        <a class="btn {{ btn_styles.upload_identified.class }}" href="{% url 'caidapp:upload_archive_contains_identities' %}"><i class="bi bi-upload"></i> Upload identified </a>
                        {% endif %}

                        <a class="btn {{ btn_styles.upload_unidentified.class }}"
                           href="{% url 'caidapp:upload_archive_contains_single_taxon' %}"><i class="bi bi-upload"></i>
                            Upload unidentified single species</a>
                        {#                        <a class="btn btn-secondary" href="{% url 'caidapp:uploads_identities' %}">#}
                        {#                            <i class="bi bi-card-list"></i>#}
                        {#                            Check uploads#}
                        {#                        </a>#}
                        <i class="bi bi-arrow-right-short fa-2x" style="vertical-align: middle;"></i>
                        {#                        <a class="btn {{ btn_styles.confirm_identification.class }} {% if btn_styles.n_for_confirmation == 0 %} disabled {% endif %} }}" href="{% url 'caidapp:get_individual_identity' %}"><i class="bi bi-question-circle"></i> Confirm identification</a>#}
                        <a class="btn {{ btn_styles.confirm_identification.class }} {% if btn_styles.n_for_confirmation == 0 %} disabled {% endif %}"
                           href="{% url 'caidapp:not_identified_mediafiles' %}"><i class="bi bi-question-circle"></i>
                            Confirm identification</a>


{#                        <i class="bi bi-arrow-right-short fa-2x" style="vertical-align: middle;"></i>#}
                        {#                        <i class="bi bi-arrow-right-short fa-2x" style="vertical-align: middle;"></i>#}
                        {#                        <a class="btn {{ btn_styles.upload_unidentified }}" href="{% url 'caidapp:upload_archive_contains_single_taxon' %}"><i class="bi bi-upload"></i> Upload unidentified  single species</a>#}
                        {#                        <i class="bi bi-arrow-right-short fa-2x" style="vertical-align: middle;"></i>#}
                        {#                        <a class="btn {{ btn_styles.run_identification }}" href="{% url 'caidapp:run_identification_on_unidentified' %}"><i class="bi bi-question-circle"></i> Identify </a>#}
                        {#                        <i class="bi bi-arrow-right-short fa-2x" style="vertical-align: middle;"></i>#}
                        {#                        <a class="btn {{ btn_styles.confirm_identification }}" href="{% url 'caidapp:get_individual_identity' %}"><i class="bi bi-question-circle"></i> Confirm identification</a>#}
                    </div>
                    <div>

                        <div class="dropdown d-inline-block">
                            <a class="btn btn-secondary dropdown-toggle" href="#" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-three-dots"></i>
                            </a>

                            <ul class="dropdown-menu">
                                <li>

                                    <a class="dropdown-item" href="{% url 'caidapp:representative_mediafiles' %}"><i class="bi bi-eye"></i> Check representative images </a>
                                </li>
                                <li>
                                    <a class="dropdown-item {{ btn_styles.init_identification.class }}"
                                       href="{% url 'caidapp:init_identification' %}"
                                            {% if user.caiduser.workgroup.identification_init_status %}
                                       data-bs-toggle="tooltip"
                                       title="Initiated at: {{ user.caiduser.workgroup.identification_init_at|date:'Y-m-d H:i' }}, {{ user.caiduser.workgroup.identification_init_status}}, {{ user.caiduser.workgroup.identification_init_message }}"
                                            {% endif %}
                                       onclick="return confirm('{{ btn_styles.init_identification.confirm }}')"
                                    ><i class="fas fa-fingerprint"></i> Init identification

                                        {% if user.caiduser.workgroup.identification_init_status == "Processing" %}
                                            <i class="fa fa-spinner fa-spin"></i>
                                        {% endif %}
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item {{ btn_styles.init_identification.class }}"
                                       href="{% url 'caidapp:train_identification' %}"
                                       onclick="return confirm('Start training of the identification model?')"
                                    >
                                        {#                            <i class="fas fa-fingerprint"></i>#}
                                        <i class="bi bi-lightning"></i>
                                        Train identification model
                                        {% if user.caiduser.workgroup.identification_train_status == "Processing" %}
                                            <i class="fa fa-spinner fa-spin"></i>
                                        {% endif %}
                                    </a>

                                </li>
                                <li>

                                    <a class="dropdown-item {{ btn_styles.run_identification.class }}" href="{% url 'caidapp:pre_identify' %}"
                                       data-bs-toggle="tooltip" title="{{ btn_styles.run_identification.tooltip }}"
                                       onclick="return confirm('{{ btn_styles.run_identification.confirm }}')"
                                    >
                                        <i class="bi bi-question-circle"></i> Compare with identity database
                                        {% if user.caiduser.workgroup.identification_reid_status == "Processing" %}
                                            <i class="fa fa-spinner fa-spin"></i>
                                        {% endif %}
                                    </a>
                                </li>
                            </ul>
                        </div>

                        {% if user.caiduser.workgroup.identification_init_status == "Processing" or  user.caiduser.workgroup.identification_init_status == "Processing" %}
                            <a class="btn btn-danger" href="{% url 'caidapp:stop_init_identification' %}"><i class="bi bi-stop-fill "></i> Stop </a>
                        {% endif %}
                        <a class="btn btn-secondary bs-1" href="{% url 'caidapp:select_reid_model' %}"><i class="bi bi-gear"></i></a>
                    </div>
                </div>
            </div>
            <h1 class="mt-4">Identification uploaded archives</h1>
            <div>
                <div class="d-flex justify-content-between">
                    <div>
                    </div>
                </div>
            </div>
        </div><!-- End Page Title -->

{#        <div  class="container-fluid">#}
            <div class="row">


            <div class="col-md-4">

                    <div class="card card-btn"
                         style="
                                 background-image:
                                 linear-gradient(to left, rgba(255, 255, 255, 0.93), rgba(255, 255, 255, 0.93)),
                                 {#url('https://cdn.pixabay.com/photo/2020/10/22/10/28/cow-5675684_960_720.jpg');#}
                                 {#url('https://cdn.pixabay.com/photo/2015/10/15/21/25/label-990091_960_720.jpg');#}
                                 {#url('https://cdn.pixabay.com/photo/2015/10/15/21/25/label-990091_960_720.jpg');#}
                                 url({% static 'caidapp/pexels-anna-nekrashevich-6801648.jpg' %});
                                 "
                    >
                        <div class="card-body">
                            <h3 class="card-title">Identification data</h3>

                            Number of identities: {{ user.caiduser.number_of_identities }}<br>
                            Number of media files in identification: {{ user.caiduser.number_of_media_files_for_identification }}<br>
                            Number of media files with known identity: {{ user.caiduser.number_of_media_files_with_known_identity }}<br>
                            Number of representative media files: {{ user.caiduser.workgroup.number_of_representative_media_files }}<br>
                            Number of media files with missing identity: {{ user.caiduser.number_of_media_files_with_missing_identity }}<br>

                            <br>
                            {% if user.caiduser.number_of_media_files_for_identification == 0 %}
                                <p>You might want to <a href="{% url 'caidapp:upload_archive_contains_single_taxon' %}">upload unidentified single species</a> or <a href="{% url 'caidapp:upload_archive_contains_single_taxon' %}">upload identified archive</a>.</p>
                            {% else %}
                                {% if user.caiduser.workgroup.number_of_representative_media_files == 0 %}
                                    <p>
                                        You might want to select representative images (marked with <i class="bi bi-star-fill"></i>>) for the identification process.
                                    </p>
                                {% endif %}

                                {% if user.caiduser.number_of_media_files_with_missing_identity > 0 %}
                                    <p>
                                    You might want to <a href="{% url 'caidapp:not_identified_mediafiles' %}">do the identification on uploaded images</a>.
                                    </p>
                                {% endif %}
                            {% endif %}
                            {#                Number of media files: {{ user.caiduser.number_of_media_files_general }}<br>#}
                            {#                Number of media files with missing taxa: {{ user.caiduser.number_of_media_files_with_missing_taxa_general }}<br>#}
                            {#                Number of media files with missing taxa verification: {{ user.caiduser.number_of_media_files_with_missing_taxa_verification_general }}<br>#}



                        </div>
                    </div>


                </div>


                <div class="col-md-4">
                    <div class="card card-btn text-reset bg-light"
{#                         href="{% url 'caidapp:representative_mediafiles' %}"#}

                         style="
                                 background-image: linear-gradient(to left, rgba(255, 255, 255, 0.96), rgba(255, 255, 255, 0.96)),
                                 {#url('https://cdn.pixabay.com/photo/2020/10/22/10/28/cow-5675684_960_720.jpg');#}
                                 {#url('https://cdn.pixabay.com/photo/2015/10/15/21/25/label-990091_960_720.jpg');#}
                                 url({% static 'caidapp/pexels-jessbaileydesign-735277.jpg' %});
                                 "
                         >
                        <div class="card-body">
                            <h3 class="card-title">Representative images</h3>
                            <div class="card-text">
                            <p>

                                Representative media files (marked with <i class="bi bi-star-fill"></i>) are used for the identification of the species. They are used in the identification process and in the identification results.
                            </p>
                            <p>
                                {% if not user.caiduser.workgroup.number_of_representative_media_files or user.caiduser.workgroup.number_of_representative_media_files == 0 %}
                                    No representative images found.
                                {% else %}
                                    Number of representative images: {{ user.caiduser.workgroup.number_of_representative_media_files }}
                                {% endif %}
                            </p>
                            </div>

                                <!-- Viditelné tlačítko (volitelné) -->


                                {% if identities_by_representative_mediafiles %}
                                    {% if identities_by_representative_mediafiles.count == 0 %}
                                        <p>
                                        There is nothing you can do here. All identities have representative media files.
                                        </p>
                                    {% else  %}
                                        <p class="mt-2">
                                            Number of identities without representative mediafile: {{ identities_by_representative_mediafiles|length }}
                                        </p>
                                        <p>
                                        Identity {{ identities_by_representative_mediafiles.0.name }} has {{ identities_by_representative_mediafiles.0.representative_mediafile_count }} representative media files.

                                        </p>
                                        <a
                                                href="{% url 'caidapp:individual_identity_mediafiles' identities_by_representative_mediafiles.0.id %}"
                                                class="btn btn-outline-primary">

                                        Select representative media files for
                                        {{  identities_by_representative_mediafiles.0.name  }}
                                        </a>

                                    {% endif %}
{#                                    <a href="{% url 'caidapp:identity'  %}">Check them</a>.#}

                                {% endif %}
                            <a
                                    href="{% url 'caidapp:representative_mediafiles' %}"
                                    class="btn btn-outline-secondary mt-2">
                                Check representative media files
                            </a>

                                <!-- Neviditelný klikací překryv celé karty -->
{#                                <a#}
{#                                        href="{% url 'caidapp:representative_mediafiles' %}"#}
{#                                        class="stretched-link"#}
{#                                        aria-label="Upload archive with known identities"></a>#}


                        </div>
                    </div>
                </div>


                <div class="col-md-4">
                    <div class="card card-btn text-reset bg-light"

                       style="
                               background-image: linear-gradient(to left, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.9)),
                               {#url('https://cdn.pixabay.com/photo/2020/10/22/10/28/cow-5675684_960_720.jpg');#}
                               url('https://cdn.pixabay.com/photo/2015/10/15/21/25/label-990091_960_720.jpg');
                               "
{#                       href="{% url 'caidapp:upload_archive_contains_identities' %}"#}
                    >
                        <div class="card-body">
                            <h3 class="card-title">
                                Upload archive with known identities
                            </h3>
                            <div class="card-text">
                                <p>
                                    If you have existing database it can be uploaded here. The uploaded archive must contain directories with the name of the identity.
                                </p>
                            </div>
                            <!-- Viditelné tlačítko (volitelné) -->
                            <a href="{% url 'caidapp:upload_archive_contains_identities' %}"
                               class="btn btn-outline-primary">
                                Upload
                            </a>

                            <!-- Neviditelný klikací překryv celé karty -->
                            <a href="{% url 'caidapp:upload_archive_contains_identities' %}"
                               class="stretched-link"
                               aria-label="Upload archive with known identities"></a>
                        </div>


                    </div>

                </div>


                <div class="col-md-4">
                    <div class="card card-btn text-reset bg-light"
                            {#                         href="{% url 'caidapp:representative_mediafiles' %}"#}

                         style="
                                 background-image: linear-gradient(to left, rgba(255, 255, 255, 0.96), rgba(255, 255, 255, 0.90)),
                                 {#url('https://cdn.pixabay.com/photo/2020/10/22/10/28/cow-5675684_960_720.jpg');#}
                                 {#url('https://cdn.pixabay.com/photo/2015/10/15/21/25/label-990091_960_720.jpg');#}
                                 {#url({% static 'caidapp/pexels-jessbaileydesign-735277.jpg' %});#}
                                 url('https://images.pexels.com/photos/3785932/pexels-photo-3785932.jpeg');
                                 "
                    >
                        <div class="card-body">
                            <h3 class="card-title">Identity suggestion</h3>
                            <div class="card-text">
                                <p>
                                    The identity suggestion is based on the comparison of the uploaded images with the representative images of known identities.
                                    The reference identity database is updated automatically when the set of representative images is changed.
                                    The suggestion generation is done automatically in the background when new media files are uploaded.
                                </p>
                                <p>
                                    {% if user.caiduser.workgroup.identification_scheduled_init_eta %}
                                        <br>
                                        Database update at:
                                        {{ user.caiduser.workgroup.identification_scheduled_init_eta|date:'Y-m-d H:i' }}
                                    {% endif %}

                                    {%  if user.caiduser.workgroup.identification_scheduled_run_eta %}
                                        <br>
                                        Suggestion generation at:
                                        {{ user.caiduser.workgroup.identification_scheduled_run_eta|date:'Y-m-d H:i' }}
                                    {% endif %}
                                </p>

                                <div class="position-absolute bottom-0 end-0 p-3">
                                    <span
                                            {#                                            data-bs-toggle="tooltip"#}
                                            {#                                            data-toggle="tooltip"#}
                                            title="Model: {{ user.caiduser.workgroup.identification_model }}&#10;
Init ({{ user.caiduser.workgroup.identification_init_status }} {{ user.caiduser.workgroup.identification_init_at|date:'Y-m-d H:i' }}): {{ user.caiduser.workgroup.identification_init_message }}
Run ({{ user.caiduser.workgroup.identification_reid_status }} {{ user.caiduser.workgroup.identification_reid_at|date:'Y-m-d H:i' }}): {{ user.caiduser.workgroup.identification_reid_message }}
"
                                    >
                                            <i class="bi bi-info-circle"></i>
                                        </span>

                                </div>
                            </div>

                            <!-- Viditelné tlačítko (volitelné) -->


{#                            <a#}
{#                                    href="{% url 'caidapp:representative_mediafiles' %}"#}
{#                                    class="btn btn-outline-secondary mt-2">#}
{#                                Check representative media files#}
{#                            </a>#}

                            <!-- Neviditelný klikací překryv celé karty -->
                            {#                                <a#}
                            {#                                        href="{% url 'caidapp:representative_mediafiles' %}"#}
                            {#                                        class="stretched-link"#}
                            {#                                        aria-label="Upload archive with known identities"></a>#}


                        </div>
                    </div>
                </div>


            </div>
{#        </div>#}
    {% endif %}





{% endblock %}

{% block script %}
    <script src="{% static 'caidapp/uploads.js' %}"></script>
    <script>

        document.addEventListener("DOMContentLoaded", function () {
            // spustí první dotaz po načtení stránky
            checkStatuses("{% url 'caidapp:uploads_status_api' 'identities' %}");
        });
    </script>

{% endblock %}